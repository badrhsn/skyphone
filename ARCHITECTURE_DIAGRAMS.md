# Dynamic Features - Architecture & Flow Diagrams

Visual reference for understanding how all components work together.

## ğŸ—ï¸ System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Frontend (React)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚   Dialer Page    â”‚      â”‚ Call History UI  â”‚             â”‚
â”‚  â”‚                  â”‚      â”‚                  â”‚             â”‚
â”‚  â”‚ useEnhancedCall  â”‚      â”‚ Analytics Data   â”‚             â”‚
â”‚  â”‚ useCallListener  â”‚      â”‚ Charts & Export  â”‚             â”‚
â”‚  â”‚ useBalanceListener               â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚          â”‚ every 3s               â”‚ on load                 â”‚
â”‚          â”‚                        â”‚                         â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                           â”‚                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                    Real-time Polling (2-3s)
                            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           â–¼                                  â”‚
â”‚                  Next.js API Layer (Backend)                â”‚
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚   Events    â”‚  â”‚ Analytics   â”‚  â”‚  Lookup     â”‚         â”‚
â”‚  â”‚ /twilio/    â”‚  â”‚ /user/call- â”‚  â”‚ /user/      â”‚         â”‚
â”‚  â”‚ events      â”‚  â”‚ analytics   â”‚  â”‚ contacts/   â”‚         â”‚
â”‚  â”‚             â”‚  â”‚             â”‚  â”‚ lookup      â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ Status Webhook   â”‚              â”‚ Transactions   â”‚      â”‚
â”‚  â”‚ /twilio/status   â”‚              â”‚ /user/         â”‚      â”‚
â”‚  â”‚ (receives POST)  â”‚              â”‚ transactions   â”‚      â”‚
â”‚  â”‚ â€¢ Updates calls  â”‚              â”‚ â€¢ History log  â”‚      â”‚
â”‚  â”‚ â€¢ Deducts balance                       â”‚ â€¢ Queries      â”‚
â”‚  â”‚ â€¢ Links contacts â”‚              â”‚ â€¢ CSV export   â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”‚ SQL Queries
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Supabase Database                         â”‚
â”‚                   (PostgreSQL)                                â”‚
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ calls  â”‚  â”‚ users  â”‚  â”‚contact â”‚  â”‚payment â”‚  â”‚ rates  â”‚ â”‚
â”‚  â”‚        â”‚  â”‚        â”‚  â”‚        â”‚  â”‚        â”‚  â”‚        â”‚ â”‚
â”‚  â”‚ â”œâ”€id   â”‚  â”‚ â”œâ”€id   â”‚  â”‚ â”œâ”€id   â”‚  â”‚ â”œâ”€id   â”‚  â”‚ â”œâ”€id   â”‚ â”‚
â”‚  â”‚ â”œâ”€sid  â”‚  â”‚ â”œâ”€bal  â”‚  â”‚ â”œâ”€name â”‚  â”‚ â”œâ”€amt  â”‚  â”‚ â”œâ”€rate â”‚ â”‚
â”‚  â”‚ â”œâ”€cost â”‚  â”‚ â”œâ”€agg  â”‚  â”‚ â”œâ”€num  â”‚  â”‚ â”œâ”€stat â”‚  â”‚ â”œâ”€ctry â”‚ â”‚
â”‚  â”‚ â”œâ”€dur  â”‚  â”‚ â””â”€...  â”‚  â”‚ â””â”€...  â”‚  â”‚ â””â”€...  â”‚  â”‚ â””â”€...  â”‚ â”‚
â”‚  â”‚ â””â”€...  â”‚  â”‚        â”‚  â”‚        â”‚  â”‚        â”‚  â”‚        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â–²
                            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           â”‚                                  â”‚
â”‚              Twilio Voice Service (External)                â”‚
â”‚                           â”‚                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚                                  â”‚
â”‚  â”‚ WebRTC SDK       â”‚     â”‚                                  â”‚
â”‚  â”‚ Browser â†â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”˜                                  â”‚
â”‚  â”‚ Phone Call       â”‚   WebRTC Connection                    â”‚
â”‚  â”‚ Connection       â”‚                                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                        â”‚
â”‚                                                               â”‚
â”‚  Status Updates Flow: â”€â”€â†’ /api/twilio/status               â”‚
â”‚                           (webhook callback)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“ Call Lifecycle Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     User Makes Call                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚  useEnhancedCall.handleCall â”‚
                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                â”‚ 1. lookupContact()          â”‚
                â”‚ 2. estimateCallCost()       â”‚
                â”‚ 3. checkBalance()           â”‚
                â”‚ 4. initDevice()             â”‚
                â”‚ 5. connect()                â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚   Twilio WebRTC SDK      â”‚
                â”‚   Establish Connection   â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                    â”‚                     â”‚
        â–¼                    â–¼                     â–¼
   [RINGING]           [ANSWERED]            [FAILED]
        â”‚                    â”‚                     â”‚
        â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
        â”‚        â”‚  Call Connected          â”‚     â”‚
        â”‚        â”‚  Twilio sends updates    â”‚     â”‚
        â”‚        â”‚  every few seconds       â”‚     â”‚
        â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
        â”‚                    â”‚                     â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚                    â”‚                     â”‚
        â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
        â”‚        â”‚  POST /api/twilio/status â”‚     â”‚
        â”‚        â”‚  Webhook Callback        â”‚     â”‚
        â”‚        â”‚  [Status Update]         â”‚     â”‚
        â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
        â”‚                    â”‚                     â”‚
        â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
        â”‚        â”‚  Process Update:         â”‚     â”‚
        â”‚        â”‚ â€¢ Update call record     â”‚     â”‚
        â”‚        â”‚ â€¢ Calculate cost         â”‚     â”‚
        â”‚        â”‚ â€¢ Deduct balance         â”‚     â”‚
        â”‚        â”‚ â€¢ Link contact           â”‚     â”‚
        â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
        â”‚                    â”‚                     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Call Ended     â”‚
                    â”‚  [COMPLETED]    â”‚
                    â”‚  [FAILED]       â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                           â”‚
                â–¼                           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ useCallListener      â”‚    â”‚ useBalanceListener â”‚
    â”‚ Poll /api/twilio/    â”‚    â”‚ Poll /api/user/    â”‚
    â”‚ events               â”‚    â”‚ profile            â”‚
    â”‚ every 3 seconds      â”‚    â”‚ every 2 seconds    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚                         â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚  UI Re-renders with:     â”‚
                â”‚ â€¢ Updated call status    â”‚
                â”‚ â€¢ New balance            â”‚
                â”‚ â€¢ Contact info           â”‚
                â”‚ â€¢ Call duration          â”‚
                â”‚ â€¢ Call cost              â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ’° Balance Deduction Process

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Call Completes                     â”‚
â”‚ CallStatus = "completed"           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ POST /api/twilio/status            â”‚
â”‚ Receives Webhook                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Parameters:                        â”‚
â”‚ â€¢ CallSid                          â”‚
â”‚ â€¢ CallStatus                       â”‚
â”‚ â€¢ CallDuration                     â”‚
â”‚ â€¢ To, From                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Find Call in Database              â”‚
â”‚ SELECT * FROM calls                â”‚
â”‚ WHERE twilioSid = $1               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Calculate Cost                     â”‚
â”‚ durationMinutes = ceil(dur/60)     â”‚
â”‚ cost = minutes Ã— rate              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Update Call Record                 â”‚
â”‚ UPDATE calls SET                   â”‚
â”‚   status = 'COMPLETED'             â”‚
â”‚   duration = X                     â”‚
â”‚   cost = $Y                        â”‚
â”‚   endedAt = now()                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Deduct from User Balance           â”‚
â”‚ UPDATE users SET                   â”‚
â”‚   balance = balance - $Y           â”‚
â”‚ WHERE id = user_id                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”‚           â”‚           â”‚
             â–¼           â–¼           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Update       â”‚ â”‚ Link to      â”‚ â”‚ Create log   â”‚
    â”‚ Contact      â”‚ â”‚ Contact      â”‚ â”‚ (metadata)   â”‚
    â”‚ last_called_ â”‚ â”‚ in calls     â”‚ â”‚              â”‚
    â”‚ at = now()   â”‚ â”‚ table        â”‚ â”‚              â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚           â”‚           â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ Return Success Response    â”‚
            â”‚ {                          â”‚
            â”‚   success: true,           â”‚
            â”‚   callId: "...",           â”‚
            â”‚   status: "completed",     â”‚
            â”‚   cost: 0.05               â”‚
            â”‚ }                          â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ” Real-time Update Cycle

```
Frontend (React)
     â”‚
     â”œâ”€ Mounted: useCallListener()
     â”‚  â””â”€ startPolling(3s interval)
     â”‚
     â”œâ”€ Mounted: useBalanceListener()
     â”‚  â””â”€ startPolling(2s interval)
     â”‚
     â”œâ”€ Call Made
     â”‚  â””â”€ handleCall() initiates WebRTC
     â”‚
  3s â”‚
     â”œâ”€ Poll #1: /api/twilio/events
     â”‚  â”œâ”€ Get recent calls
     â”‚  â”œâ”€ Find call with status=ANSWERED
     â”‚  â”œâ”€ Update state
     â”‚  â””â”€ Re-render UI
     â”‚
  2s â”‚
     â”œâ”€ Poll #1: /api/user/profile
     â”‚  â”œâ”€ Get user balance
     â”‚  â”œâ”€ Detect balance changed
     â”‚  â”œâ”€ Update state + history
     â”‚  â””â”€ Re-render UI
     â”‚
  6s â”‚
     â”œâ”€ Poll #2: /api/twilio/events
     â”‚  â””â”€ Still connected
     â”‚
  4s â”‚
     â”œâ”€ Poll #2: /api/user/profile
     â”‚  â””â”€ Balance deducted
     â”‚
  9s â”‚
     â”œâ”€ Poll #3: /api/twilio/events
     â”‚  â”œâ”€ Call status=COMPLETED
     â”‚  â”œâ”€ Update with final duration
     â”‚  â””â”€ Final re-render
     â”‚
  6s â”‚
     â””â”€ Poll #3: /api/user/profile
        â””â”€ Final balance confirmed

Total Latency: ~2-9 seconds for full UI update
(From call end to UI showing completion)
```

## ğŸ“Š Analytics Data Query Flow

```
User Opens Call History Page
        â”‚
        â–¼
GET /api/user/call-analytics?days=30
        â”‚
        â”œâ”€ Calculate date range (30 days ago - now)
        â”‚
        â”œâ”€ Query all calls in range
        â”‚  â””â”€ SELECT * FROM calls WHERE userId=X AND createdAt BETWEEN Y AND Z
        â”‚
        â”œâ”€ Calculate aggregate stats:
        â”‚  â”œâ”€ Total calls count
        â”‚  â”œâ”€ Completed vs failed count
        â”‚  â”œâ”€ Total duration (seconds)
        â”‚  â”œâ”€ Average duration
        â”‚  â”œâ”€ Total cost (sum)
        â”‚  â””â”€ Average cost
        â”‚
        â”œâ”€ Generate top countries:
        â”‚  â”œâ”€ GROUP BY country
        â”‚  â”œâ”€ COUNT calls
        â”‚  â”œâ”€ SUM cost and duration
        â”‚  â””â”€ LIMIT 10
        â”‚
        â”œâ”€ Generate daily stats:
        â”‚  â”œâ”€ GROUP BY date
        â”‚  â”œâ”€ COUNT calls per day
        â”‚  â”œâ”€ SUM cost per day
        â”‚  â”œâ”€ Calculate success rate
        â”‚  â””â”€ Build trend array
        â”‚
        â””â”€ Return JSON response
             â”‚
             â–¼
        Frontend Renders:
        â”œâ”€ Summary cards (4 cards)
        â”œâ”€ Top countries section (10 rows)
        â”œâ”€ Top numbers section (10 rows)
        â”œâ”€ Recent calls table (20 rows)
        â””â”€ Export button
```

## ğŸ” Contact Auto-Detection Flow

```
User Dials Number: +447911123456
        â”‚
        â–¼
useEnhancedCall.handleCall()
        â”‚
        â”œâ”€ lookupContact("+447911123456")
        â”‚  â”‚
        â”‚  â–¼
        â”‚  GET /api/user/contacts/lookup?phone=%2B447911123456
        â”‚  â”‚
        â”‚  â”œâ”€ SELECT * FROM contacts
        â”‚  â”‚  WHERE userId=X AND phoneNumber="+447911123456"
        â”‚  â”‚
        â”‚  â””â”€ Response:
        â”‚     â”œâ”€ found: true
        â”‚     â””â”€ contact: { name, email, country, ... }
        â”‚
        â”œâ”€ setContactInfo(contact)
        â”‚
        â””â”€ UI displays contact banner
           â”œâ”€ Contact name
           â”œâ”€ Email
           â””â”€ Last called date

On Call Completion:
        â”‚
        â”œâ”€ Call disconnected
        â”‚
        â”œâ”€ POST /api/user/contacts/lookup
        â”‚  {
        â”‚    contactId: "...",
        â”‚    action: "update_last_called"
        â”‚  }
        â”‚
        â””â”€ UPDATE contacts SET updatedAt = now()
           WHERE id = contact_id
```

## ğŸ¯ Summary: Data Flow Path

```
Browser WebRTC â† Twilio SDK â†’ Twilio Servers
     â†‘                            â†“
     â”‚                       Call Status Updates
     â”‚                            â†“
  UI Shows               POST /api/twilio/status
  Real-time:                      â†“
  â€¢ Balance            Database Updates (Prisma)
  â€¢ Contact            â”œâ”€ Call record updated
  â€¢ Call Status        â”œâ”€ Balance decremented
  â€¢ Duration           â””â”€ Contact linked
                            â†“
                    Frontend Polls (every 2-3s)
                    â”œâ”€ /api/twilio/events
                    â”œâ”€ /api/user/profile
                    â””â”€ /api/user/call-analytics
                            â†“
                       UI Re-renders
                       â”œâ”€ Call history
                       â”œâ”€ Balance
                       â”œâ”€ Analytics
                       â””â”€ Recent calls
```

---

## Legend

```
â†’  Sync request (immediate)
â†“  Data flow
â† Polling/subscription
âŸ² Cycle/loop
```
